# AssetFlow - AI Coding Assistant Rules & Best Practices

## ğŸŒ CRITICAL: Language Policy

**ALL code, documentation, and user-facing text MUST be in English only.**

- âœ… English variable names: `userName`, `createUser()`
- âœ… English comments: `// Fetch user data`
- âœ… English error messages: "User not found"
- âœ… English UI labels: "Sign In", "Dashboard"
- âœ… English documentation: README.md, CONTRIBUTING.md
- âŒ No Spanish: `nombreUsuario`, `crearUsuario()`, "Usuario no encontrado"

## ğŸ—ï¸ Project Architecture

### Stack
- **Backend:** Node.js + Express + Prisma ORM + PostgreSQL
- **Frontend:** React 19 + Vite + TailwindCSS
- **Auth:** JWT with bcrypt
- **Payments:** Stripe subscriptions
- **Emails:** Resend API
- **Deployment:** Railway (monorepo with 2 services)

### Multi-Tenancy
- **Shared Database, Shared Schema** approach
- Every query MUST filter by `organizationId`
- Users are isolated by organization
- Middleware: `attachOrganization` + `requireOrganization`

### Subscription System
- 3 tiers: FREE, PRO, ENTERPRISE
- Limits enforced via `checkSubscriptionLimits` middleware
- Stripe webhook handles payment events
- Email notifications for subscription changes

## ğŸ“ Project Structure

```
assetflow-ticketing-platform/
â”œâ”€â”€ backend/
â”‚   â”œâ”€â”€ index.js              # Main Express server
â”‚   â”œâ”€â”€ middleware/           # Auth, organization, subscription
â”‚   â”œâ”€â”€ utils/                # Auth helpers, email functions
â”‚   â”œâ”€â”€ config/               # Stripe configuration
â”‚   â”œâ”€â”€ prisma/               # Schema + migrations
â”‚   â””â”€â”€ __tests__/            # Jest unit tests
â””â”€â”€ frontend/
    â””â”€â”€ src/
        â”œâ”€â”€ components/       # React components
        â”œâ”€â”€ context/          # AuthContext
        â””â”€â”€ api/              # Axios client
```

## ğŸ”’ Security Best Practices

### Authentication
- Always use `authenticateToken` middleware for protected routes
- Never expose JWT secrets in code
- Hash passwords with bcrypt (10 salt rounds minimum)
- Tokens expire in 7 days
- Store tokens in localStorage (frontend)

### Authorization
- Use `requireAdmin` for admin-only endpoints
- Always attach organization context: `attachOrganization`
- Never allow cross-organization data access
- Validate all user inputs before database queries

### Data Isolation
```javascript
// âœ… CORRECT: Filter by organization
const assets = await prisma.asset.findMany({
  where: { organizationId: req.organizationId }
});

// âŒ WRONG: Global query without org filter
const assets = await prisma.asset.findMany();
```

## ğŸ’¾ Database Patterns

### Prisma Conventions
- Use transactions for multi-step operations
- Always include error handling with try-catch
- Use `include` for eager loading related data
- Use `select` to limit returned fields
- Migrations only - never use `db push` in production

### Example Query Pattern
```javascript
try {
  const ticket = await prisma.ticket.create({
    data: {
      title,
      description,
      userId: req.user.id,
      assetId: parseInt(assetId),
      organizationId: req.organizationId
    },
    include: {
      user: true,
      asset: true
    }
  });
  res.json(ticket);
} catch (error) {
  console.error('Create ticket error:', error);
  res.status(500).json({ error: 'Failed to create ticket' });
}
```

## ğŸ›¡ï¸ Error Handling Standards

### Backend
- Always wrap async operations in try-catch
- Return descriptive error messages
- Log errors with context: `console.error('Operation error:', error)`
- Use appropriate HTTP status codes:
  - 400: Bad Request (validation errors)
  - 401: Unauthorized (missing/invalid token)
  - 403: Forbidden (insufficient permissions, limit reached)
  - 404: Not Found
  - 500: Internal Server Error

### Error Message Format
```javascript
// âœ… GOOD: Descriptive and actionable
return res.status(403).json({
  error: 'Limit reached',
  message: 'Your Free plan allows up to 10 tickets. Please upgrade to add more.',
  currentCount: 10,
  limit: 10,
  tier: 'FREE'
});

// âŒ BAD: Generic and unhelpful
return res.status(500).json({ error: 'Error' });
```

## ğŸ¨ Frontend Conventions

### Component Structure
- Functional components with hooks
- Use AuthContext for user state
- Axios interceptors for token injection
- TailwindCSS for styling (no custom CSS unless necessary)

### API Calls
```javascript
// âœ… CORRECT: Use apiClient with automatic auth
import apiClient from '../api/client';

const response = await apiClient.get('/assets');

// âŒ WRONG: Manual fetch without auth handling
const response = await fetch('http://localhost:3000/api/assets');
```

### UI/UX Patterns
- Loading states for all async operations
- Error messages displayed to users
- Disabled buttons during submission
- Confirmation dialogs for destructive actions
- Responsive design (mobile-first)

## ğŸ“¬ Email Notifications

### When to Send
- User registration: Welcome email
- Ticket creation: Notify all admins
- Subscription changes: Confirmation email

### Email Best Practices
- Always check if `RESEND_API_KEY` is configured
- Graceful degradation if email fails (log warning, don't crash)
- Include actionable links in email body
- Use professional HTML templates

```javascript
// âœ… CORRECT: Graceful degradation
if (!process.env.RESEND_API_KEY) {
  console.log('âš ï¸  RESEND_API_KEY not configured, skipping email');
  return;
}
```

## ğŸ’³ Stripe Integration

### Webhook Handling
- **CRITICAL:** Webhook MUST be before `express.json()`
- Use `express.raw({ type: 'application/json' })` for webhook
- Verify signature with `stripe.webhooks.constructEvent()`
- Handle events: `checkout.session.completed`, `customer.subscription.updated`, `customer.subscription.deleted`

### Checkout Flow
1. Create Stripe customer (or reuse existing)
2. Create checkout session with metadata (organizationId, tier)
3. Redirect user to Stripe
4. Handle webhook to update database
5. Send confirmation email

## ğŸ§ª Testing Standards

### Jest Configuration
- Test files: `__tests__/**/*.test.js`
- Mock external dependencies (Prisma, Stripe, Resend)
- Test utilities in isolation
- Aim for >80% coverage on critical paths

### Test Patterns
```javascript
describe('Auth Utils', () => {
  it('should hash password correctly', async () => {
    const password = 'password123';
    const hashed = await hashPassword(password);
    expect(hashed).not.toBe(password);
    expect(hashed.startsWith('$2b$')).toBe(true);
  });
});
```

## ğŸ“ Code Style

### JavaScript/JSX
- Use `const` by default, `let` when reassignment needed
- Arrow functions for callbacks
- Async/await over Promise.then()
- Destructuring for cleaner code
- Template literals over string concatenation

### Naming Conventions
- **Variables:** camelCase (`userName`, `assetCount`)
- **Functions:** camelCase (`createUser`, `fetchAssets`)
- **Components:** PascalCase (`LoginForm`, `Dashboard`)
- **Constants:** UPPER_SNAKE_CASE (`JWT_SECRET`, `MAX_RETRIES`)
- **Files:** kebab-case (`user-management.js`, `auth-context.jsx`)

### Comments
- Explain "why", not "what"
- Document complex business logic
- JSDoc for public functions
- No commented-out code in commits

## ğŸš€ Deployment (Railway)

### Environment Variables
**Backend:**
- `DATABASE_URL` - PostgreSQL connection
- `JWT_SECRET` - Min 32 characters
- `FRONTEND_URL` - For CORS
- `STRIPE_SECRET_KEY`, `STRIPE_WEBHOOK_SECRET`
- `STRIPE_PRO_PRICE_ID`, `STRIPE_ENTERPRISE_PRICE_ID`
- `RESEND_API_KEY`

**Frontend:**
- `VITE_API_URL` - Backend API URL

### Build Commands
- Backend: `prisma generate && prisma migrate deploy`
- Frontend: `vite build`

## ğŸ”„ Git Workflow

### Commit Message Format
```
type(scope): description

Examples:
feat(auth): add user invitation endpoint
fix(webhook): move webhook before express.json
docs(readme): update deployment instructions
refactor(tickets): improve error handling
test(auth): add password hashing tests
```

### Branch Strategy
- `main` - Production-ready code
- `develop` - Integration branch
- `feature/*` - New features
- `fix/*` - Bug fixes

## ğŸ¯ File Organization Rules

### When Creating New Files

**Backend:**
- Routes: Add to `backend/index.js` (monolithic for now)
- Middleware: `backend/middleware/{name}.js`
- Utils: `backend/utils/{name}.js`
- Tests: `backend/__tests__/unit/{name}.test.js`

**Frontend:**
- Components: `frontend/src/components/{Name}.jsx`
- Context: `frontend/src/context/{Name}Context.jsx`
- Utils: `frontend/src/utils/{name}.js`

## ğŸš« What NOT to Do

### Backend
- âŒ Don't use `db push` in production (use migrations)
- âŒ Don't expose sensitive data in API responses
- âŒ Don't allow queries without organization filtering
- âŒ Don't forget try-catch in async functions
- âŒ Don't use `app.use(express.json())` before Stripe webhook

### Frontend
- âŒ Don't store sensitive data in localStorage (except token)
- âŒ Don't make API calls without error handling
- âŒ Don't bypass apiClient for authenticated requests
- âŒ Don't hardcode API URLs (use env variables)

### General
- âŒ Don't commit `.env` files
- âŒ Don't use Spanish in any code or documentation
- âŒ Don't skip input validation
- âŒ Don't ignore TypeScript errors (if added later)

## ğŸ¨ UI Component Patterns

### Button States
```jsx
<button
  onClick={handleSubmit}
  disabled={loading}
  className={`btn ${loading ? 'opacity-50 cursor-not-allowed' : ''}`}
>
  {loading ? 'Processing...' : 'Submit'}
</button>
```

### Form Validation
```jsx
if (!description || !description.trim()) {
  setError('Description is required');
  return;
}
```

### Conditional Rendering
```jsx
{isAdmin && (
  <button>Admin Only Feature</button>
)}
```

## ğŸ“Š Performance Considerations

- Use pagination for large datasets
- Implement debouncing for search inputs
- Lazy load heavy components
- Optimize images (use WebP when possible)
- Minimize bundle size (tree-shaking)

## ğŸ” Code Review Checklist

Before submitting code:
- [ ] All text is in English
- [ ] Error handling implemented
- [ ] Organization filtering applied (if applicable)
- [ ] Input validation added
- [ ] Tests written (if applicable)
- [ ] No console.logs (except intentional logging)
- [ ] Environment variables used (not hardcoded)
- [ ] CORS configured correctly
- [ ] Responsive on mobile

## ğŸ“š Additional Resources

- **Prisma Docs:** https://www.prisma.io/docs
- **Stripe API:** https://stripe.com/docs/api
- **React Docs:** https://react.dev
- **TailwindCSS:** https://tailwindcss.com/docs
- **Railway:** https://docs.railway.app

---

**Remember: When in doubt, prioritize security, user experience, and English language consistency.**
